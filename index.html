const SUPABASE_URL = 'https://igfdlteumfiizbsrijxs.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnZmRsdGV1bWZpaXpic3JpanhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDkwOTgsImV4cCI6MjA3MzU4NTA5OH0.4_g2UOf5gDRtRlINweKS8fdwhg_dho14W3eMu6x-LqU';

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const customerList = document.getElementById('customer-list');
const dialog = document.getElementById('customer-dialog');
const modalTitle = document.getElementById('modal-title');
const form = document.getElementById('customer-form');
const detailsView = document.getElementById('details-view');
const spinner = document.getElementById('spinner');
const addNewBtn = document.getElementById('add-new-btn');
const closeBtn = document.querySelector('.close-btn');

document.addEventListener('DOMContentLoaded', loadCustomers);
addNewBtn.addEventListener('click', () => openFormModal());
closeBtn.addEventListener('click', () => dialog.close());
form.addEventListener('submit', handleFormSubmit);

async function loadCustomers() {
    customerList.innerHTML = '<div class="loader"></div>';
    
    const { data, error } = await supabaseClient
        .from('loans')
        .select('*')
        .eq('status', 'Active')
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error fetching customers:', error);
        customerList.innerHTML = `<p style="color:red;">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>`;
        return;
    }

    displayCustomers(data);
}

function displayCustomers(customers) {
    customerList.innerHTML = '';
    if (customers.length === 0) {
        customerList.innerHTML = '<p>ยังไม่มีข้อมูลลูกค้า</p>';
        return;
    }
    customers.forEach(cust => {
        const item = document.createElement('div');
        item.className = 'customer-item';
        item.dataset.customerId = cust.id;
        item.onclick = () => viewCustomerDetails(cust.id);

        item.innerHTML = `
            <div class="customer-info">${cust.borrower_name} - ${cust.loan_amount.toLocaleString()} บาท</div>
            <div class="customer-status status-${cust.status}">${cust.status}</div>
        `;
        customerList.appendChild(item);
    });
}

async function handleFormSubmit(event) {
    event.preventDefault();
    spinner.style.display = 'block';

    const formData = new FormData(form);
    const customerId = formData.get('customerId');
    
    let imageUrl1 = document.getElementById('preview1').src;
    let imageUrl2 = document.getElementById('preview2').src;

    const file1 = formData.get('imageFile1');
    if (file1 && file1.size > 0) {
        imageUrl1 = await uploadImage(file1);
    }
    
    const file2 = formData.get('imageFile2');
    if (file2 && file2.size > 0) {
        imageUrl2 = await uploadImage(file2);
    }

    const loanData = {
        borrower_name: formData.get('borrowerName'),
        loan_amount: parseFloat(formData.get('loanAmount')),
        interest_rate: parseFloat(formData.get('interestRate')),
        loan_days: parseInt(formData.get('loanDays')),
        image_url_1: imageUrl1,
        image_url_2: imageUrl2,
    };

    let result;
    if (customerId) {
        result = await supabaseClient.from('loans').update(loanData).eq('id', customerId);
    } else {
        result = await supabaseClient.from('loans').insert([loanData]);
    }
    
    spinner.style.display = 'none';

    if (result.error) {
        alert('เกิดข้อผิดพลาด: ' + result.error.message);
    } else {
        alert(customerId ? 'อัปเดตข้อมูลสำเร็จ!' : 'เพิ่มลูกค้าใหม่สำเร็จ!');
        dialog.close();
        loadCustomers();
    }
}

async function uploadImage(file) {
    const fileName = `${Date.now()}_${file.name}`;
    
    const { data, error } = await supabaseClient.storage
        .from('images')
        .upload(fileName, file);

    if (error) {
        console.error('Image Upload Error:', error);
        return null;
    }
    
    const { data: { publicUrl } } = supabaseClient.storage
        .from('images')
        .getPublicUrl(fileName);
        
    return publicUrl;
}

function openFormModal(customerData = null) {
    form.reset();
    document.getElementById('preview1').style.display = 'none';
    document.getElementById('preview2').style.display = 'none';
    form.style.display = 'block';
    detailsView.style.display = 'none';

    if (customerData) {
        modalTitle.innerText = 'แก้ไขข้อมูลลูกค้า';
        document.getElementById('customerId').value = customerData.id;
        document.getElementById('borrowerName').value = customerData.borrower_name;
        document.getElementById('loanAmount').value = customerData.loan_amount;
        document.getElementById('interestRate').value = customerData.interest_rate;
        document.getElementById('loanDays').value = customerData.loan_days;

        if (customerData.image_url_1) {
            const preview1 = document.getElementById('preview1');
            preview1.src = customerData.image_url_1;
            preview1.style.display = 'block';
        }
        if (customerData.image_url_2) {
            const preview2 = document.getElementById('preview2');
            preview2.src = customerData.image_url_2;
            preview2.style.display = 'block';
        }
    } else {
        modalTitle.innerText = 'เพิ่มลูกค้าใหม่';
    }

    dialog.showModal();
}

async function viewCustomerDetails(customerId) {
    spinner.style.display = 'block';
    
    const { data: customer, error } = await supabaseClient
        .from('loans')
        .select('*')
        .eq('id', customerId)
        .single();

    spinner.style.display = 'none';
    
    if (error) {
        alert('ไม่สามารถดึงข้อมูลลูกค้าได้: ' + error.message);
        return;
    }

    form.style.display = 'none';
    detailsView.style.display = 'block';
    modalTitle.innerText = 'รายละเอียดลูกค้า';

    document.getElementById('detail-name').innerText = customer.borrower_name;
    document.getElementById('detail-amount').innerText = customer.loan_amount.toLocaleString();
    document.getElementById('detail-interest-rate').innerText = customer.interest_rate;
    document.getElementById('detail-status').innerText = customer.status;
    document.getElementById('detail-img1').src = customer.image_url_1 || 'https://via.placeholder.com/150?text=No+Image';
    document.getElementById('detail-img2').src = customer.image_url_2 || 'https://via.placeholder.com/150?text=No+Image';
    
    const editBtn = document.getElementById('edit-btn');
    const closeLoanBtn = document.getElementById('close-loan-btn');
    
    editBtn.onclick = () => openFormModal(customer);
    closeLoanBtn.onclick = () => closeLoan(customer.id, customer.borrower_name);

    dialog.showModal();
}

async function closeLoan(customerId, customerName) {
    if (!confirm(`คุณต้องการปิดยอดของ ${customerName} ใช่หรือไม่?`)) return;

    spinner.style.display = 'block';
    
    const { error } = await supabaseClient
        .from('loans')
        .update({ status: 'Closed' })
        .eq('id', customerId);

    spinner.style.display = 'none';
    
    if (error) {
        alert('เกิดข้อผิดพลาดในการปิดยอด: ' + error.message);
    } else {
        alert('ปิดยอดเรียบร้อยแล้ว');
        dialog.close();
        loadCustomers();
    }
}
